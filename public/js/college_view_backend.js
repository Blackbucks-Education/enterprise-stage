const defaultTop100Students = [
  {
    image: "https://lh3.googleusercontent.com/a/ACg8ocI403Tc7AiHF4TGkux5ffIj8zwl8n8qU1xOgJVaqU4G=s96-c",
    first_name: "Shaik Sana",
    email: "shaiksana2710@gmail.com",
    aptitude: "77",
    english: "43",
    coding: "36",
    total_score: "51",
    comment: "If you improve English score by 7 and Technical score by 14 then you can achieve Band-A",
    employability_band: "F",
    possible_employability_band: "A",
    aptitude_improvement_suggestions: "Practise Easy and Medium level",
    english_improvement_suggestions: "Practise Difficult level Grammar+LSRW.",
    technical_improvement_suggestions: "Learn JavaScript+C++/Java+DSA. Practise Difficulty level questions"
  },
  {
    image: "https://lh3.googleusercontent.com/a/ACg8ocK_TF7W3ZIKKYFpAmrcUwov4yGz-hkKRLuwCNKbwnoCIg=s96-c",
    first_name: "Noti Tejaswini",
    email: "tejaswininoti@gmail.com",
    aptitude: "73",
    english: "33",
    coding: "41",
    total_score: "50",
    comment: "If you improve English score by 18 and Technical score by 10 then you can achieve Band-A",
    employability_band: "F",
    possible_employability_band: "A",
    aptitude_improvement_suggestions: "Practise Easy and Medium level",
    english_improvement_suggestions: "Practise Difficult level Grammar+LSRW.",
    technical_improvement_suggestions: "Learn JavaScript+C++/Java+DSA. Practise Difficulty level questions"
  },
  {
    image: "",
    first_name: "Pakala Sumathi",
    email: "pakalasumathi@gmail.com",
    aptitude: "70",
    english: "33",
    coding: "36",
    total_score: "47",
    comment: "If you improve English score by 18 and Technical score by 14 then you can achieve Band-A",
    employability_band: "F",
    possible_employability_band: "A",
    aptitude_improvement_suggestions: "Practise Easy and Medium level",
    english_improvement_suggestions: "Practise Difficult level Grammar+LSRW.",
    technical_improvement_suggestions: "Learn JavaScript+C++/Java+DSA. Practise Difficulty level questions"
  },
  {
    image: "https://blackbucks-media.s3.ap-south-1.amazonaws.com/Sree .jpg",
    first_name: "Chitteti Sreevidhya",
    email: "sreevidhyachitteti@gmail.com",
    aptitude: "63",
    english: "36",
    coding: "36",
    total_score: "45",
    comment: "If you improve English score by 15 and Technical score by 14 then you can achieve Band-A",
    employability_band: "F",
    possible_employability_band: "A",
    aptitude_improvement_suggestions: "Practise Easy and Medium level",
    english_improvement_suggestions: "Practise Difficult level Grammar+LSRW.",
    technical_improvement_suggestions: "Learn JavaScript+C++/Java+DSA. Practise Difficulty level questions"
  },
  {
    image: "https://lh3.googleusercontent.com/a/ACg8ocK6GisSgwYh3B5aJLa08QSpJdj__D2O4-7do8a1rvk8RV0=s96-c",
    first_name: "Tharugu Divya Snehankitha",
    email: "snehankitha2002@gmail.com",
    aptitude: "97",
    english: "42",
    coding: "8",
    total_score: "45",
    comment: "If you improve English score by 8 and Technical score by 43 then you can achieve Band-A",
    employability_band: "F",
    possible_employability_band: "A",
    aptitude_improvement_suggestions: "Practise Easy level",
    english_improvement_suggestions: "Practise Difficult level Grammar+LSRW.",
    technical_improvement_suggestions: "Learn JavaScript+C++/Java+DSA. Practise Difficulty level questions"
  },
  {
    image: "https://lh3.googleusercontent.com/a/ACg8ocJmNRCRpCKSdfpzrXEam5OIdlKRtZKxnXbnEgz2f982kA=s96-c",
    first_name: "Bheemisetty Tejasri",
    email: "tejasrib372@gmail.com",
    aptitude: "27",
    english: "29",
    coding: "67",
    total_score: "45",
    comment: "If you improve English score by 21 and Technical score by 3 then you can achieve Band-A",
    employability_band: "F",
    possible_employability_band: "A",
    aptitude_improvement_suggestions: "Practise Difficult level",
    english_improvement_suggestions: "Practise Difficult level Grammar+LSRW.",
    technical_improvement_suggestions: "Learn DSA+SQL. Practise Difficulty level questions"
  },
  {
    image: "https://lh3.googleusercontent.com/a/ACg8ocI4WIx8iRgTdDOGMooPPPhYGNtkY3e4eJCOjL8AKtDkESo=s96-c",
    first_name: "Patukota Chandana",
    email: "chandhupatukota246@gmail.com",
    aptitude: "93",
    english: "46",
    coding: "6",
    total_score: "44",
    comment: "If you improve English score by 5 and Technical score by 44 then you can achieve Band-A",
    employability_band: "F",
    possible_employability_band: "A",
    aptitude_improvement_suggestions: "Practise Easy level",
    english_improvement_suggestions: "Practise Difficult level Grammar+LSRW.",
    technical_improvement_suggestions: "Learn JavaScript+C++/Java+DSA. Practise Difficulty level questions"
  },
  {
    image: "https://blackbucks-media.s3.ap-south-1.amazonaws.com/1000021711.jpg",
    first_name: "Sirasanambeti Rakesh",
    email: "sirasanambetirakesh131101@gmail.com",
    aptitude: "100",
    english: "43",
    coding: "0",
    total_score: "43",
    comment: "If you improve English score by 8 and Technical score by 50 then you can achieve Band-A",
    employability_band: "F",
    possible_employability_band: "A",
    aptitude_improvement_suggestions: "Practise Easy level",
    english_improvement_suggestions: "Practise Difficult level Grammar+LSRW.",
    technical_improvement_suggestions: "Learn JavaScript+C++/Java+DSA. Practise Difficulty level questions"
  }
];

const defaultAlumniDetails = {
  "alumniDetails": [
    {
      "image": "",
      "name": "Gopisetty Munuswamy ",
      "btechdegree": "B.E./B.Tech",
      "btechbranch": "Electronics and Communication Engineering",
      "yop": 2020
    },
    {
      "image": "https://lh3.googleusercontent.com/a/AEdFTp6kbgb6DCKWsQPKaOrYl79vwJVRXhijHwpTxiR7jg=s96-c",
      "name": "jayasurya j",
      "btechdegree": "B.Sc",
      "btechbranch": "CSE- Data Science",
      "yop": 2022
    },
    {
      "image": "https://taptap.blackbucks.me/pluginfile.php/20298/user/icon/edumy/f1?rev=180258",
      "name": "Blackbuck L",
      "btechdegree": "B.Com",
      "btechbranch": "B.Com General",
      "yop": 2023
    }
  ]
}

const defaultCourses =[
  {
    "id": 22,
    "description": "AICTE",
    "name": "B.tech Computer Science",
    "duration": "4 years",
    "seats_offered": 125,
    "median_salary": true,
    "median_salary_description": "12 LPA"
  },
  {
    "id": 23,
    "description": "AICTE",
    "name": "B.Tech Electronics",
    "duration": "4 Years",
    "seats_offered": 100,
    "median_salary": true,
    "median_salary_description": "7 LPA"
  },
  {
    "id": 24,
    "description": "AICTE ",
    "name": "B.tech Mechanical Branch",
    "duration": "4 Years",
    "seats_offered": 70,
    "median_salary": false,
    "median_salary_description": ""
  }
]

const defaultCollegeData = [
  {
    "name": "Blackbucks Education ",
    "type": "Engineering College",
    "location": "Hyderabad",
    "logo": "https://awsbucketbbinternaldevelopment.s3.ap-south-1.amazonaws.com/1723012003427-Image%20%283%29.svg",
    "college_banner": "https://awsbucketbbinternaldevelopment.s3.ap-south-1.amazonaws.com/1723012003658-Group%202980.png",
    "description": "Blackbucks Education, Andhra Pradesh, is a prestigious institution known for its commitment to academic excellence and innovation in the field of engineering and technology. Established with a vision to impart quality education, ASCET has grown to become a center of learning and research, fostering an environment of intellectual rigor and professional development.",
    "images": "https://awsbucketbbinternaldevelopment.s3.ap-south-1.amazonaws.com/1723012004102-Image%20%283%29.svg",
    "bus": true,
    "cafeteria": true,
    "gym": false,
    "hostel": true,
    "hostel_description": "Girls Hostel | Boys Hostel",
    "nirf_description": "Blackbucks Education, stands out as a distinguished institution in the realm of engineering education. With its focus on academic excellence, research, and community engagement, ASCET continues to contribute significantly to the field of engineering and technology, shaping the future leaders and innovators of tomorrow.",
    "library": true,
    "library_description": "The sprawling campus of ASCET is equipped with state-of-the-art infrastructure and facilities that cater to the diverse needs of its students. The college boasts modern classrooms, well-equipped laboratories, a comprehensive library, and advanced computer centers. Additionally, the campus offers amenities such as a cafeteria, medical facilities, hostel accommodations, and transportation services to ensure a comfortable and conducive learning environment.",
    "sports_complex": false,
    "sports_complex_description": "",
    "labs": true,
    "labs_description": "Computer Lab | Chemical Lab | Physics Lab | Mechanical Lab",
    "medical_facilities": true,
    "wifi": true,
    "nirf_rank": "300-350"
  }
]

const defaultStudentsData = [
  {
    name: 'Patukota Chandana Patukota',
    roll_number: '21G25A0511',
    branch: 'Computer Science and Engineering',
    year: 2024,
    score: 44
  },
  {
    name: 'Shaik Arshiya Arshiya',
    roll_number: '20G21A05F2',
    branch: 'Computer Science and Engineering',
    year: 2024,
    score: 9
  },
  {
    name: 'Gosangi Venkata Tharun',
    roll_number: '20G21A0556',
    branch: 'Computer Science and Engineering',
    year: 2024,
    score: 19
  },
  {
    name: 'Thalluru Pravallika T',
    roll_number: '20G21A05G9',
    branch: 'Computer Science and Engineering',
    year: 2024,
    score: 12
  },
  {
    name: 'Hari Dama Dama',
    roll_number: '21G25A3103',
    branch: 'CSE - Artificial Intelligence',
    year: 2024,
    score: 27
  },
  {
    name: 'Pakala Sumathi',
    roll_number: '20G21A05C6',
    branch: 'Computer Science and Engineering',
    year: 2024,
    score: 47
  },
  {
    name: 'Bodugu Divya Bodugu',
    roll_number: '20G21A3211',
    branch: 'CSE- Data Science',
    year: 2024,
    score: 38
  },
  {
    name: 'Koteswari Vempala',
    roll_number: '20G21A05I7',
    branch: 'Computer Science and Engineering',
    year: 2024,
    score: 18
  },
  {
    name: 'Chengari Siva',
    roll_number: '20G21A0531',
    branch: 'Computer Science and Engineering',
    year: 2024,
    score: 11
  },
  {
    name: 'Challa Harsha Vardhan',
    roll_number: '20G21A3111',
    branch: 'CSE - Artificial Intelligence',
    year: 2024,
    score: 27
  },
  {
    name: 'Pandillapalli Charan Reddy',
    roll_number: '20G21A3235',
    branch: 'CSE- Data Science',
    year: 2025,
    score: 4
  },
  {
    name: 'Dhushyanth ObulReddy',
    roll_number: '20G21A3135',
    branch: 'CSE - Artificial Intelligence',
    year: 2024,
    score: 17
  },
  {
    name: 'Guntamadugu Saranya Saranya',
    roll_number: '20G21A0560',
    branch: 'Computer Science and Engineering',
    year: 2024,
    score: 34
  }
];

let collegeId;


//Access college id
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

function decodeJWT(token) {
    const payload = token.split('.')[1]; // Get the payload part of the JWT
    const decodedPayload = atob(payload); // Decode Base64 payload
    return JSON.parse(decodedPayload); // Parse it as JSON
}


const token = getCookie("userAdminToken");
if (token) {
    const decodedData = decodeJWT(token);
    collegeId = decodedData.college;
} else {
    console.log("No token found in cookies");
}


document.addEventListener('DOMContentLoaded', async () => {
  
  
  if (!collegeId) {
    console.error('College ID not found in URL');
    return;
  }

  // Fetch and display college data
  try {
    const response = await fetch(`/api/collegeView/fetchCollegeData/${collegeId}`);
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }

    const data = await response.json();
    console.log('collegeData',data);
    if (data.length === 0 || !data) {
      console.log("There is no college Id for this user so default data is showing.........")
      data = defaultCollegeData;
      document.getElementById('ranking').style.opacity = "0.5";
      showPop();
    }

   displayCollegeDetails(data)

  } catch (error) {
    console.error('Error fetching college data:', error.message);
    console.log("There is no college Id for this user so default data is showing.........");
    
    displayCollegeDetails(defaultCollegeData);
    document.getElementById('ranking').style.opacity = "0.5";
    showPop();
  }


let collegeName;
  
function displayCollegeDetails(data){
  const college = data[0]; // Assuming only one result is returned
  localStorage.setItem("collegeName", college.name) ;

  const collegeNameElement = document.querySelector('#collegeName');
  if (collegeNameElement) collegeNameElement.textContent = college.name;

  const collegeNElement = document.querySelector('#collegeN');
  if (collegeNElement) collegeNElement.textContent = college.name;

  const collegeTypeElement = document.querySelector('#collegeType');
  if (collegeTypeElement) collegeTypeElement.textContent = college.type;

  const collegeLocationElement = document.querySelector('#collegeLocation');
  if (collegeLocationElement) collegeLocationElement.textContent = college.location;

  const collegeDescriptionElement = document.querySelector('#collegeDescription');
  if (collegeDescriptionElement) collegeDescriptionElement.textContent = college.description;

  const collegeBannerElement = document.querySelector('#collegeBanner');
  if (collegeBannerElement) collegeBannerElement.src = college.college_banner;

  const collegeLogoElement = document.querySelector('#collegeLogo');
  if (collegeLogoElement) collegeLogoElement.src = college.logo;

  const collegeImagesElement = document.querySelector('#collegeImages');
  if (collegeImagesElement) collegeImagesElement.src = college.images;

  const collegeBusElement = document.querySelector('#collegeBus');
  if (collegeBusElement) collegeBusElement.textContent = college.bus ? 'Yes' : 'No';

  const collegeCafeteriaElement = document.querySelector('#collegeCafeteria');
  if (collegeCafeteriaElement) collegeCafeteriaElement.textContent = college.cafeteria ? 'Yes' : 'No';

  const collegeGymElement = document.querySelector('#collegeGym');
  if (collegeGymElement) collegeGymElement.textContent = college.gym ? 'Yes' : 'No';

  const collegeHostelElement = document.querySelector('#collegeHostel');
  if (collegeHostelElement) collegeHostelElement.textContent = college.hostel ? 'Yes' : 'No';

  const collegeHostelDescriptionElement = document.querySelector('#collegeHostelDescription');
  if (collegeHostelDescriptionElement) collegeHostelDescriptionElement.textContent = college.hostel_description;

  const collegeNirfDescriptionElement = document.querySelector('#collegeNirfDescription');
  if (collegeNirfDescriptionElement) collegeNirfDescriptionElement.textContent = college.nirf_description;

  const collegeNirfRankElement = document.querySelector('#collegeNirfRank');
  if (collegeNirfRankElement) collegeNirfRankElement.textContent = college.nirf_rank;



  const collegeLibraryElement = document.querySelector('#collegeLibrary');
  if (collegeLibraryElement) collegeLibraryElement.textContent = college.library ? 'Yes' : 'No';

  const collegeLibraryDescriptionElement = document.querySelector('#collegeLibraryDescription');
  if (collegeLibraryDescriptionElement) collegeLibraryDescriptionElement.textContent = college.library_description;

  const collegeSportsComplexElement = document.querySelector('#collegeSportsComplex');
  if (collegeSportsComplexElement) collegeSportsComplexElement.textContent = college.sports_complex ? 'Yes' : 'No';

  const collegeSportsComplexDescriptionElement = document.querySelector('#collegeSportsComplexDescription');
  if (collegeSportsComplexDescriptionElement) collegeSportsComplexDescriptionElement.textContent = college.sports_complex_description;

  const collegeLabsElement = document.querySelector('#collegeLabs');
  if (collegeLabsElement) collegeLabsElement.textContent = college.labs ? 'Yes' : 'No';

  const collegeLabsDescriptionElement = document.querySelector('#collegeLabsDescription');
  if (collegeLabsDescriptionElement) collegeLabsDescriptionElement.textContent = college.labs_description;

  const collegeMedicalFacilitiesElement = document.querySelector('#collegeMedicalFacilities');
  if (collegeMedicalFacilitiesElement) collegeMedicalFacilitiesElement.textContent = college.medical_facilities ? 'Yes' : 'No';

  const collegeWifiElement = document.querySelector('#collegeWifi');
  if (collegeWifiElement) collegeWifiElement.textContent = college.wifi ? 'Yes' : 'No';
}



  // Fetch and display course data
  try {
    const response = await fetch(`/api/collegeView/fetchCourses/${collegeId}`);
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }

    const courses = await response.json();
    if (courses.length === 0) {
      courses = defaultCourses;
      document.getElementById("allCourses").style.opacity = "0.5";
    }

    displayCourses(courses);
    
   
  } catch (error) {
    console.error('Error fetching courses data:', error.message);
    displayCourses(defaultCourses);
    document.getElementById("allCourses").style.opacity = "0.5";

  }


  function displayCourses (courses){
    const coursesContainer = document.querySelector('.college_courses');
    coursesContainer.innerHTML = ''; // Clear any existing content
    courses.forEach(course => {
      const medianSalaryBlock = course.median_salary_description
        ? `
          <div class="info-block">
            <p class="info-title">Median Salary</p>
            <p class="info-detail">â‚¹${course.median_salary_description}</p>
          </div>
        `
        : ''; // If median_salary_description is falsy, this will be an empty string

      const medianSalaryDot = course.median_salary_description ? ` Â· ${course.median_salary_description}` : ''; // Conditionally add the dot and description

      const courseCard = `
        <div class="course-card">
          <div class="course-header">
            <h3>${course.name}</h3>
            <div class="bookmark-btn">ðŸ•®</div>
          </div>
          <div class="course-details">
            <div class="rating" style="font-size: 12px;">
              <span>&#11088;</span> ${course.duration}${medianSalaryDot} Â· ${course.description}
            </div>
            <hr>
            <div class="course-info">
              <div class="info-block">
                <p class="info-title">Seats Offered</p>
                <p class="info-detail">${course.seats_offered}</p>
              </div>
              <div class="info-block">
                <p class="info-title">Duration</p>
                <p class="info-detail">${course.duration}</p>
              </div>
              ${medianSalaryBlock}
            </div>
          </div>
        </div>
      `;
      coursesContainer.insertAdjacentHTML('beforeend', courseCard);
    });
  }

  // Fetch and display infrastructure data
  try {
    const response = await fetch(`/api/collegeView/fetchCollegeData/${collegeId}`);
    if (!response.ok) throw new Error('Network response was not ok');

    const data = await response.json(); // Handle as array with single object
    console.log(data);
    console.log(data.length)
    if(data.length==0){
      data = defaultCollegeData;
      // document.getElementById("infrastructure").style.opacity = "0.5";
    }
    
    // if (!college) throw new Error('College not found');
    showInfrastructure(data);
    console.log('Fetched data for infrastructure:', college);

    
  } catch (error) {
    console.error('Error fetching infrastructure data:', error.message);
    // showInfrastructure(defaultCollegeData);
    // document.getElementById("infrastructure").style.opacity = "0.5";
  }


  function showInfrastructure(data){
    const [college] = data;
    const infrastructureContainer = document.getElementById('infraContainer');
    if (!infrastructureContainer) {
      console.error('Infrastructure container not found');
      return;
    }

    // Infrastructure Container
    infrastructureContainer.innerHTML = ''; // Clear existing content
    const infrastructureItemsWithDescription = [
      { key: 'library', label: 'Library', description: college.library_description, icon: 'img/library.svg', isVisible: college.library },
      { key: 'hostel', label: 'Hostel', description: college.hostel_description, icon: 'img/hostel.svg', isVisible: college.hostel },
      { key: 'sports_complex', label: 'Sports Complex', description: college.sports_complex_description, icon: 'img/sports.svg', isVisible: college.sports_complex },
      { key: 'labs', label: 'Labs', description: college.labs_description, icon: 'img/labs.svg', isVisible: college.labs }
    ];

    // Infrastructure items without descriptions
    const infrastructureItemsWithoutDescription = [
      { key: 'cafeteria', label: 'Cafeteria', icon: 'img/cafeteria.svg', isVisible: college.cafeteria },
      { key: 'gym', label: 'Gym', icon: 'img/gym.svg', isVisible: college.gym },
      { key: 'medical_facilities', label: 'Medical Facilities', icon: 'img/hospital.svg', isVisible: college.medical_facilities },
      { key: 'wifi', label: 'Wifi', icon: 'img/wifi.svg', isVisible: college.wifi },
      { key: 'bus', label: 'Bus', icon: 'img/bus.svg', isVisible: college.bus }
    ];

    // Display items with descriptions
    infrastructureItemsWithDescription.forEach(item => {
      if (item.isVisible) {
        const infrastructureHTML = `
          <div style="display: flex; flex-direction: row; align-items: center;">
            <div style="display: flex; flex-direction: column; margin: 10px 20px 0; width: 5%;">
              <img src="${item.icon}" alt="${item.label}" width="40px" height="40px">
              <p style="font-size: 12px; font-weight: 600; margin: 0;">${item.label}</p>
            </div>
            <p style="font-size: 12px; margin: 10px 20px 0; width: 80%;">${item.description || 'No description available'}</p>
          </div>
          <hr>
        `;
        infrastructureContainer.insertAdjacentHTML('beforeend', infrastructureHTML);
      }
    });

    // Display items without descriptions in a single row
    const noDescriptionHTML = `
      <div style="display: flex; flex-direction: row; align-items: center; margin-top: 10px; justify-content:space-between">
        ${infrastructureItemsWithoutDescription
          .filter(item => item.isVisible)
          .map(item => `
            <div style="display: flex; flex-direction: column; margin: 10px 20px 0; width: 5%;">
              <img src="${item.icon}" alt="${item.label}" width="40px" height="40px">
              <p style="font-size: 12px; font-weight: 600; margin: 0;">${item.label}</p>
            </div>
          `).join('')}
      </div>
    `;
    infrastructureContainer.insertAdjacentHTML('beforeend', noDescriptionHTML);
  
  }


  //Fetch and display top 100 students data 
  try {
    const response = await fetch(`/api/collegeView/top100/${collegeId}`);
    if (!response.ok) throw new Error('Failed to fetch top 100 students');

    const students = await response.json();

    if(students.length===0){
      students = defaultTop100Students;
      document.getElementById("top100-table").style.opacity = "0.5";
    }


    displayTop100Students(students)
    
  } catch (error) {
    console.error('Error fetching top 100 students:', error.message);
    console.log(defaultTop100Students);
    displayTop100Students(defaultTop100Students)
    document.getElementById("top100-table").style.opacity = "0.5";
  }

function displayTop100Students(students){
  console.log(students,"calling function for top 100 studnets");
  const studentTableBody = document.querySelector('#studentTable tbody');

    studentTableBody.innerHTML = ''; // Clear any existing rows

    students.forEach(student => {
      const imageUrl = student.image ? student.image : 'img/sidebarLogo.png'; // Replace with your default image path

      const studentRow = `
        <tr>
          <td> <div style="display: flex; align-items: center;">
            <img src="${imageUrl}" alt="${student.first_name}" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">
            ${student.first_name}
          </div>
         </td>
          <td>${student.email}</td>
          <td><span class="marks">${student.total_score}</span></td>
          <td>${student.aptitude}</td>
          <td>${student.english}</td>
          <td>${student.coding}</td>
          <td>${student.employability_band}</td>
          <td>${student.possible_employability_band}</td>
          <td>${student.aptitude_improvement_suggestions}</td>
          <td>${student.english_improvement_suggestions}</td>
          <td>${student.technical_improvement_suggestions}</td>
        </tr>
      `;
      studentTableBody.insertAdjacentHTML('beforeend', studentRow);
    
    }
  
  );
  
}

  fetchBranches(collegeId);
  fetchYears(collegeId);
  fetchFilteredStudents(collegeId); 
  fetchTopStudents(collegeId);
  // Call the function with the appropriate college ID
  fetchAlumniDetails(collegeId); // Replace 872 with the dynamic college ID as needed
  fetchCollegeOverview(collegeId); // Replace '123' with the actual college_id you want to fetch

  fetchCollegeDetails(collegeId);

  //Pagenation function call 
  paginateTable('studentTable', 'paginationControlsStudent', 10); // 10 rows per page for student table

});

function paginateTable(tableId, paginationId, itemsPerPage) {
  const table = document.getElementById(tableId);
  const paginationControls = document.getElementById(paginationId);
  const rows = table.querySelectorAll('tbody tr');
  const totalItems = rows.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  let currentPage = 1;

  function showPage(page) {
    const start = (page - 1) * itemsPerPage;
    const end = start + itemsPerPage;

    rows.forEach((row, index) => {
      row.style.display = index >= start && index < end ? '' : 'none';
    });

    currentPage = page;
    updatePaginationControls();
  }

  function updatePaginationControls() {
    paginationControls.innerHTML = '';

    const createPageButton = (page, text, isActive) => {
      const pageButton = document.createElement('button');
      pageButton.textContent = text;
      pageButton.className = `page-btn${isActive ? ' active' : ''}`;
      pageButton.disabled = isActive;
      pageButton.addEventListener('click', () => showPage(page));
      return pageButton;
    };

    // Previous button
    if (currentPage > 1) {
      const prevButton = createPageButton(currentPage - 1, 'Previous');
      paginationControls.appendChild(prevButton);
    }

    // Page number buttons with dots
    const visiblePages = [];
    if (totalPages <= 4) {
      for (let i = 1; i <= totalPages; i++) {
        visiblePages.push(i);
      }
    } else {
      if (currentPage <= 3) {
        visiblePages.push(1, 2, 3, 4);
      } else if (currentPage >= totalPages - 2) {
        visiblePages.push(totalPages - 3, totalPages - 2, totalPages - 1, totalPages);
      } else {
        visiblePages.push(currentPage - 1, currentPage, currentPage + 1);
        visiblePages.unshift('...');
      }
    }

    visiblePages.forEach((page, index) => {
      if (page === '...') {
        const dots = document.createElement('span');
        dots.textContent = '...';
        paginationControls.appendChild(dots);
      } else {
        const pageButton = createPageButton(page, page, page === currentPage);
        paginationControls.appendChild(pageButton);
      }
    });

    // Next button
    if (currentPage < totalPages) {
      const nextButton = createPageButton(currentPage + 1, 'Next');
      paginationControls.appendChild(nextButton);
    }
  }

  // Initialize by showing the first page
  showPage(1);
}


// Function to fetch and display filtered students based on selected branch and year
async function fetchFilteredStudents(collegeId) {
  const selectedBranchButton = document.querySelector('.branch.selected');
  const branch = selectedBranchButton ? selectedBranchButton.textContent : ''; // Get the selected branch
  const year = document.getElementById('year-filter').value; // Get the selected year



 
  
  //default Data



  try {
    const response = await fetch(`/api/collegeView/filteredStudents/${collegeId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ branch, year }), // Send branch and year in the request body
    });

    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const data = await response.json();
    if(data.length==0){
      data = defaultStudentsData;
      document.getElementById("responsiveTable").style.opacity = "0.5";
    }
    displayStudents(data); // Display the filtered students
  } catch (error) {
    console.error('Error fetching filtered students:', error);
    displayStudents(defaultStudentsData);
    document.getElementById("responsiveTable").style.opacity = "0.5";
  }
}

// Function to display students
function displayStudents(students) {
  const studentList = document.querySelector('.responsive-table');
  studentList.innerHTML = ''; // Clear the current list

  // Create and add header
  const header = document.createElement('li');
  header.classList.add('table-row', 'header-row');
  header.innerHTML = `
    <div class="col col-1" data-label="Name">Name</div>
    <div class="col col-2" data-label="Regno">Registration Number</div>
    <div class="col col-3" data-label="Branch">Branch</div>
    <div class="col col-4" data-label="Year">Year</div>
    <div class="col col-5" data-label="Average Emp Score">Average Employability Score</div>
  `;
  studentList.appendChild(header);

  // Add student rows
  students.forEach(student => {
    const row = document.createElement('li');
    row.classList.add('table-row');

    row.innerHTML = `
      <div class="col col-1" data-label="Name">
        <div style="width:20px; height:20px; background-color: orange; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:5px;">
          <i class="fa-solid fa-user" style="color:white;"></i>
        </div>
        ${student.name}
      </div>
      <div class="col col-2" data-label="Regno">${student.roll_number}</div>
      <div class="col col-3" data-label="Branch">${student.branch}</div>
      <div class="col col-4" data-label="Year">${student.year}</div>
      <div class="col col-5" data-label="Average Emp Score"><span class="marks">${student.score}</span></div>
    `;

    studentList.appendChild(row);
  });
}

// Function to toggle the active state of branch buttons
function toggleBranchSelection(branch) {
  const buttons = document.querySelectorAll('.branch');
  const urlParams = new URLSearchParams(window.location.search);
  const collegeId = urlParams.get('college_id');
  buttons.forEach(button => {
    if (button.textContent === branch) {
      button.classList.toggle('selected');
    } else {
      button.classList.remove('selected');
    }
  });

  // Show all students if no branch is selected
  const selectedButton = document.querySelector('.branch.selected');
  
  if (!selectedButton) {
    fetchFilteredStudents(collegeId);
  }
}

// Add event listeners to branch buttons
function attachBranchEventListeners() {
  document.querySelectorAll('.branch').forEach(button => {
    button.addEventListener('click', () => {
      filterBranch(button.textContent);
    });
  });
}

// Function to filter by branch
function filterBranch(branch) {
  const year = document.getElementById('year-filter').value; // Get the selected year
  toggleBranchSelection(branch);
  fetchFilteredStudents(collegeId);
}

// Function to fetch and display branches
async function fetchBranches(collegeId) {
  try {
    const response = await fetch(`/api/collegeView/branches/${collegeId}`);
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const branches = await response.json();
    const branchContainer = document.querySelector('.branches');
    branchContainer.innerHTML = ''; // Clear the current buttons

    branches.forEach(branch => {
      const button = document.createElement('button');
      button.classList.add('branch');
      button.textContent = branch;
      branchContainer.appendChild(button);
    });

    // Reattach event listeners after rendering buttons
    attachBranchEventListeners();
  } catch (error) {
    console.error('Error fetching branches:', error);
  }
}

// Function to fetch and display years
async function fetchYears(collegeId) {
  try {
    const response = await fetch(`/api/collegeView/years/${collegeId}`);
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const years = await response.json();
    const yearFilter = document.getElementById('year-filter');
    yearFilter.innerHTML = '<option value="">Select Year</option>'; // Reset the year filter

    years.forEach(year => {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      yearFilter.appendChild(option);
    });
  } catch (error) {
    console.error('Error fetching years:', error);
  }
}

// Add event listener to year filter dropdown
document.getElementById('year-filter').addEventListener('change', function () {
  const urlParams = new URLSearchParams(window.location.search);
  const collegeId = urlParams.get('college_id');
  fetchFilteredStudents(collegeId);
  
});


//Top 10 students 
async function fetchTopStudents(collegeId) {
  try {
    const response = await fetch(`/api/collegeView/top10/${collegeId}`);
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    const data = await response.json();
    displayTopStudents(data);
  } catch (error) {
    console.error('Error fetching top students:', error);
  }
}

function displayTopStudents(students) {
  const studentContainer = document.querySelector('.student-container');
  studentContainer.innerHTML = ''; // Clear existing content

  students.forEach(student => {
    const card = document.createElement('div');
    card.classList.add('top-card');

    card.innerHTML = `
      <div class="top-textBox">
        <div class="top-textContent">
          <p class="top-h1">${student.first_name}</p>
          <p class="top-p">Employability Score: ${student.total_score}%</p>
        </div>
        <div>
          <span class="top-span">
            <i class="fa-solid fa-user-graduate" onclick="toggleTooltip(this)"></i>
            <p class="tooltip-text">View Profile</p>
          </span>
        </div>
      </div>
    `;

    studentContainer.appendChild(card);
  });
}


async function fetchAlumniDetails(collegeId) {
  try {
    const response = await fetch(`api/collegeView/alumni/${collegeId}`);
    const { alumniDetails, alumniCount } = await response.json();

    if (!response.ok) {
      throw new Error('Failed to fetch alumni details');
    }

    // Display alumni count in HTML
    document.querySelector('.alumni-count').textContent = `${alumniCount}`;

    const carouselContainer = document.querySelector('.al-cards');
    const paginationContainer = document.querySelector('.alpagination');
    const prevButton = document.querySelector('.al-prev-btn');
    const nextButton = document.querySelector('.al-next-btn');

    if (!carouselContainer || !paginationContainer || !prevButton || !nextButton) {
      throw new Error('Required DOM elements not found');
    }

    let currentPage = 1;
    const itemsPerPage = 3;
    const totalPages = Math.ceil(alumniDetails.length / itemsPerPage);

    function renderPage(pageNumber) {
      const start = (pageNumber - 1) * itemsPerPage;
      const end = start + itemsPerPage;

      carouselContainer.innerHTML = ''; // Clear existing cards

      alumniDetails.slice(start, end).forEach(alumni => {
        const alumniCard = document.createElement('div');
        alumniCard.className = 'al-card';
        alumniCard.innerHTML = `
          <div class="al-bg">
            <img src="img/background.svg" alt="background" class="al-bg-img">
            <img src="${alumni.image || 'img/sidebarLogo.png'}" alt="${alumni.name}" class="al-profile-img">
          </div>
          <div style="padding: 10px;">
            <h3 style="height:48px;">${alumni.name}</h3>
            <p style="height:65px;">${alumni.btechdegree} | ${alumni.btechbranch} | YOP: ${alumni.yop}</p>
            <button class="al-profile-btn">View Profile</button>
          </div>
        `;
        carouselContainer.appendChild(alumniCard);
      });

      // Update pagination bar
      paginationContainer.innerHTML = `
        <div class="al-pagination-bar">
          <div class="al-pagination-indicator" style="width: ${((pageNumber / totalPages) * 100)}%"></div>
        </div>
      `;

      prevButton.disabled = pageNumber === 1;
      nextButton.disabled = pageNumber === totalPages;
    }

    function navigateToPage(pageNumber) {
      if (pageNumber < 1 || pageNumber > totalPages) return;
      currentPage = pageNumber;
      renderPage(currentPage);
    }

    // Event listeners for buttons
    prevButton.addEventListener('click', () => navigateToPage(currentPage - 1));
    nextButton.addEventListener('click', () => navigateToPage(currentPage + 1));

    // Initialize the first page
    renderPage(currentPage);

  } catch (error) {
    console.error('Error fetching alumni details:', error);
    // Optionally display the error to the user in the UI
  }
}

async function fetchCollegeOverview(collegeId) {
  try {
    const response = await fetch(`/api/collegeView/overview/${collegeId}`);
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.message || 'Failed to fetch college overview');
    }

    // Update HTML with fetched data
    document.querySelector('.emp-score').textContent = `${data.emp_score}`;
    document.querySelector('.total-students').textContent = `${data.total_students}`;
  } catch (error) {
    console.error('Error fetching college overview:', error);
    // Optionally display an error message in the UI
  }
}


// Function to fetch college details based on the college ID
async function fetchCollegeDetails(id) {
  try {
    const response = await fetch(`api/collegeView/bbrank/${id}`);
    if (!response.ok) {
      if (response.status === 404) {
        document.getElementById('errorMessage').textContent = 'College details not found.';
      } else {
        document.getElementById('errorMessage').textContent = 'An error occurred while fetching the details.';
      }
      return;
    }

    const data = await response.json();
    
    if (data.length > 0) {
      const { college_id, rank, college_code, college_name } = data[0];

      document.getElementById('BBrank').textContent = rank;
      document.getElementById('CollegeCode').textContent = college_code;
      document.getElementById('CC').textContent = college_code;
      document.getElementById('BBcollegeCode').textContent = college_code;
      document.getElementById('BBcollegeName').textContent = college_name;

      document.getElementById('errorMessage').textContent = ''; // Clear any previous error message
    } else {
      document.getElementById('errorMessage').textContent = 'College details not found.';
    }
  } catch (error) {
    console.error('Error fetching data:', error);
    document.getElementById('errorMessage').textContent = 'An error occurred while fetching the details.';
  }
}





function showPop(){
  document.getElementById('popup-overlay').classList.add('show');
}

function closePopup(){
  document.getElementById('popup-overlay').classList.remove('show');
}